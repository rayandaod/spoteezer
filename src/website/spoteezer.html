<!DOCTYPE html>
<html>

<head>
    <title>Spoteezer</title><link rel="icon" type="image/png" href="spoteezer_assets/spoteezer.png">
    <link rel='stylesheet' type='text/css' href='spoteezer_style.css'>
    <link rel="apple-touch-icon" href="spoteezer_assets/apple-touch-icon.png">
</head>

<body>
    <div id="head">
        <h1>Spoteezer</h1>
        <img src="spoteezer_assets/spoteezer.png" alt="Spoteezer logo" id="spoteezer-logo">
    </div>
    
    <div id="center-elems">
        <input id="init-link" placeholder="Deezer or Spotify link (track, album, or artist)">
        <button id="convert-button">Convert</button>
    </div>
    
    <div id="results">
        <img src="" id="platform"/>
        <a id="cover-link" href="">
            <img id="cover-img" src="" alt="Cover">
        </a>
        <a id="info"></a>
        <a id="more-info"></a>
        <div id="logs"></div>
    </div>
    

    <a href="https://github.com/rayandaod/spoteezer">
        <img src="spoteezer_assets/github_logo.png" alt="GitHub logo" id="github-logo">
    </a>

    <script>
        const form = document.getElementById('center-elems');
        const initLinkInput = document.getElementById('init-link');
        const buttonElement = document.getElementById('convert-button');

        const imgElement = document.getElementById('cover-img');
        const imgLinkElement = document.getElementById('cover-link');

        const infoElement = document.getElementById('info');
        const moreInfoElement = document.getElementById('more-info');
        const logElement = document.getElementById('logs');

        function dictToString(dict) {
            let str = '';
            for (const key in dict) {
                if (dict.hasOwnProperty(key)) {
                    const capitalizedKey = key.charAt(0).toUpperCase() + key.slice(1);
                    str += '<b>' + capitalizedKey + '</b>: ' + dict[key] + ' ';
                }
            }
            return str;
        }

        // Add an event listener to the form to handle the submission
        buttonElement.addEventListener('click', (event) => {
            event.preventDefault();

            // Get the init link from the input
            const initLink = initLinkInput.value;

            // Clear the result and log elements
            imgElement.style.display = 'none'
            imgLinkElement.href = '';
            imgElement.src = '';
            infoElement.innerHTML = '';
            moreInfoElement.innerHTML = '';
            logElement.innerHTML = '';

            // Send a GET request to the server with the init link
            // fetch('https://rayandaod.pythonanywhere.com/convert', {
            fetch('http://127.0.0.1:8080/convert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ initLink: initLink }),
            })
                .then((response) => {
                    // When the server responds, parse the response as JSON
                    return response.json();
                })
                .then((data) => {
                    // Get the result link and log messages from the response data
                    const resultLink = data.result.result_link;
                    const platform = data.result.platform;
                    const img_src = data.result.img_src;
                    const type = data.result.type;
                    const info = data.result.info[type];
                    delete data.result.info[type]
                    const more_info = data.result.info;
                    const log = data.log;

                    // Set the image element to the img src and make it clickable
                    if (img_src != '') {
                        imgElement.style.display = 'block';
                        imgElement.src = img_src;
                        imgLinkElement.href = resultLink;
                    }

                    // Set the platform element to the platform
                    if (platform == 'Deezer') {
                        document.getElementById('platform').src = 'spoteezer_assets/deezer_logo.png';
                    } else if (platform == 'Spotify') {
                        document.getElementById('platform').src = 'spoteezer_assets/spotify_logo.png';
                    }

                    // Display the platform logo
                    document.getElementById('platform').style.display = 'block';

                    // Set the info element to the info
                    infoElement.innerHTML = '' + type.charAt(0).toUpperCase() + type.slice(1) + ': <a href="' + resultLink + '">' + info + '</a>';
                    moreInfoElement.innerHTML = dictToString(more_info);

                    // Display the result div border
                    document.getElementById('results').style.borderWidth = '1px';

                    // Set the log element to the log messages
                    logElement.innerHTML = log;
                })
                .catch((error) => {
                    // If there is an error, log it to the console and set the log element to the error message
                    console.error(error);
                    logElement.innerHTML = 'An error occurred: ' + error + ' Try again.';
                });
        });

    </script>
</body>

</html>